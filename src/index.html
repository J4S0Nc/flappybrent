<html>

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<link rel="manifest" href="manifest.json">
	<meta name="theme-color" content="#96c93e" />
	<link rel="icon" sizes="192x192" href="assets/brent0.png">
	<link rel="apple-touch-icon" href="assets/brent0.png">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="#96c93e">
	<meta name="apple-mobile-web-app-title" content="Flappy Brent">
	<meta name="msapplication-TileImage" content="assets/brent0.png">
	<meta name="msapplication-TileColor" content="#96c93e">
	<style>
		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
			touch-action: none;
		}

		body,
		html {
			width: 100%;
			height: 100%;
			background: #333;
		}

		body {
			position: fixed;
		}

		#container {
			display: grid;
			height: 100%;
		}

		#viewport {
			max-width: 100%;
			max-height: 100%;
			margin: auto;
			background: #000;
		}
	</style>
</head>

<body>
	<div id='container'>
		<noscript><strong>We're sorry but the web doesn't work properly without JavaScript enabled. Enable it to stop
				being an idiot.</strong></noscript>
		<canvas id='viewport' width='1920' height='1080'></canvas>
		<audio id='music' src='assets/music.mp3' />

	</div>
	<script>
		if ('serviceWorker' in navigator) {
			navigator.serviceWorker.register('service-worker.js')
				.then(function () {
					console.log('Service Worker Registered');
				});
		}
	</script>
	<script type='module'>

		import Game from './game.js'
		import View from './view.js'

		const TICK = 1000 / 240 // 240 updates / second

		let game = new Game()
		const view = new View()
		const canvas = document.getElementById('viewport')
		const ctx = canvas.getContext('2d', { alpha: false })
		const input = []
		const music = document.getElementById('music')

		document.addEventListener('keyup', () => input.push(true))
		document.addEventListener('click', () => input.push(true))
		
		let time = performance.now()
		requestAnimationFrame(loop)

		function loop() {
			requestAnimationFrame(loop)

			const now = performance.now()
			while (time + TICK <= now) {				
				const flapping = input.shift()
				const finished = game.update(flapping)
				if (finished) game = new Game()
				time += TICK
			}

			view.render(game, ctx)

			if (game.started && game.flappy.death === 0) {
				music.play()
			} else {
				music.pause()
				music.currentTime = 0.5
			}
		}

		function fullscreen() {
			if (canvas.webkitRequestFullScreen) {
				canvas.webkitRequestFullScreen()
			}
			else if (canvas.mozRequestFullScreen) {
				canvas.mozRequestFullScreen()
			}
		}
	</script>
</body>

</html>